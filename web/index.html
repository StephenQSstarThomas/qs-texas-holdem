<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Texas Hold'em - Web UI</title>
  <style>
    html,body{height:100%}
    body{margin:0;background:#0f1419;color:#e5e7eb;font:14px/1.5 system-ui,Segoe UI,Microsoft YaHei,sans-serif}
    .app{display:grid;grid-template-columns:minmax(260px,22vw) 1fr minmax(320px,28vw);gap:12px;padding:12px}
    .panel{background:linear-gradient(180deg,#171d24,#1c2430);border:1px solid #2a3745;border-radius:12px;box-shadow:0 8px 24px rgba(0,0,0,.25);overflow:hidden}
    .players,.controls{padding:12px;display:flex;flex-direction:column;gap:10px}
    .player{display:grid;grid-template-columns:52px 1fr auto;gap:10px;align-items:center;background:#111827;border:1px solid #243041;border-radius:10px;padding:8px}
    .avatar{width:52px;height:52px;border-radius:50%;display:grid;place-items:center;background:radial-gradient(circle at 30% 30%,#7dd3fc,#2563eb);font-weight:900}
    .seat{position:absolute;transform:translate(-50%,-50%);display:grid;grid-template-columns:58px 1fr auto;gap:10px;align-items:center;background:#121a22;border:1px solid #2b3a4a;border-radius:16px;padding:10px 12px;box-shadow:0 16px 36px rgba(0,0,0,.35)}
    .turn{outline:2px solid #f2c94c;box-shadow:0 0 0 4px rgba(242,201,76,.15),0 16px 36px rgba(0,0,0,.45)}
    .table-wrap{position:relative;min-height:min(72vh,960px);display:grid;place-items:center;padding:12px}
    .table{position:relative;width:100%;height:100%;background:radial-gradient(120% 85% at 50% 40%,#174235,#16352a);border-radius:48px/36px;border:6px solid #0a2018;box-shadow:inset 0 0 0 2px #1d4e3b,0 40px 80px rgba(0,0,0,.35)}
    .community{position:absolute;left:50%;top:38%;transform:translate(-50%,-50%);display:flex;gap:min(1.2vw,16px)}
    .card{width:min(7.2vw,110px);aspect-ratio:64/90;border-radius:10px;background:linear-gradient(180deg,#fff,#f5f5f5);border:2px solid #d7dce3;display:grid;place-items:center;color:#111827;font-weight:900;font-size:clamp(18px,3.2vw,34px);box-shadow:0 4px 20px rgba(0,0,0,.25)}
    .red{color:#d51e3f}
    .pot{position:absolute;left:50%;top:55%;transform:translate(-50%,0);display:flex;gap:8px;align-items:center;padding:8px 14px;border-radius:999px;background:#0f1419;border:1px solid #2b3a4a;color:#f2c94c;font-weight:900}
    .btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:12px 16px;border-radius:10px;border:1px solid #2b3a4a;background:#121a22;color:#dbeafe;cursor:pointer;font-weight:800}
    .btn.blue{background:linear-gradient(180deg,#2563eb,#1e40af);border:none}
    .btn.gray{background:linear-gradient(180deg,#6b7280,#4b5563);border:none}
    .btn.red{background:linear-gradient(180deg,#f97316,#b45309);border:none}
    .range{display:flex;align-items:center;gap:8px}
    .value{min-width:120px;text-align:right;color:#f2c94c;font-weight:900}
    .hist{max-height:28vh;overflow:auto;border-top:1px dashed #243041;padding-top:8px}
  </style>
</head>
<body>
  <main class="app">
    <aside class="panel players" id="players">
      <!-- æ–°æ¸¸æˆè®¾ç½® -->
      <div style="display:flex;flex-direction:column;gap:8px;margin-bottom:8px">
        <div style="font-weight:800;color:#cbd5e1">æ–°æ¸¸æˆ</div>
        <div style="display:flex;gap:6px;flex-wrap:wrap;align-items:center">
          <label>å°ç›²</label><input id="sb" type="number" value="10" min="1" step="1" style="width:80px;background:#0f1419;color:#e5e7eb;border:1px solid #2a3745;border-radius:6px;padding:4px 6px"/>
          <label>å¤§ç›²</label><input id="bb" type="number" value="20" min="2" step="1" style="width:80px;background:#0f1419;color:#e5e7eb;border:1px solid #2a3745;border-radius:6px;padding:4px 6px"/>
        </div>
        <div id="playersCfg" style="display:flex;flex-direction:column;gap:6px"></div>
        <div style="display:flex;gap:6px">
          <button class="btn" id="addP">+ ç©å®¶</button>
          <button class="btn blue" id="btnNewGame">å¼€å§‹æ–°ç‰Œå±€å¹¶å‘ç‰Œ</button>
        </div>
        <hr style="border:none;border-top:1px dashed #243041"/>
      </div>
    </aside>
    <section class="panel table-wrap">
      <div class="table" id="table">
        <div class="community" id="community"></div>
        <div class="pot" id="pot">å¥–æ± : 0</div>
        <div id="seats"></div>
      </div>
    </section>
    <aside class="panel controls">
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <button class="btn gray" id="fold">å¼ƒç‰Œ(F)</button>
        <button class="btn blue" id="call">è·Ÿæ³¨(Space)</button>
        <button class="btn red"  id="raise">åŠ æ³¨(R)</button>
        <button class="btn" id="allin" style="background:linear-gradient(180deg,#f59e0b,#b45309);border:none;color:#111827">å…¨æŠ¼(A)</button>
      </div>
      <div class="range">
        <input id="slider" type="range" min="0" max="2000" value="200" step="10" style="flex:1"/>
        <div class="value" id="val">Â¥ 200</div>
      </div>
      <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px">
        <button class="btn" data-q="min">æœ€å°</button>
        <button class="btn" data-q="half">1/2åº•æ± </button>
        <button class="btn" data-q="pot">åº•æ± </button>
        <button class="btn" data-q="double">2xåº•æ± </button>
      </div>
      <div style="font-size:12px;color:#93c5fd;margin:8px 0" id="debug">çŠ¶æ€: ç­‰å¾…</div>
      <div class="hist" id="hist"></div>
    </aside>
  </main>

  <script>
    // å…¼å®¹ file:// æ‰“å¼€æ—¶æ²¡æœ‰ host çš„æƒ…å†µï¼Œé»˜è®¤ä½¿ç”¨æœ¬æœº 127.0.0.1
    const wsHost = (location.hostname && location.hostname.length>0) ? location.hostname : '127.0.0.1';
    const wsScheme = (location.protocol==='https:'?'wss':'ws');
    const ws = new WebSocket(`${wsScheme}://${wsHost}:8000/ws`);
    const $ = (s,p=document)=>p.querySelector(s);
    const $$ = (s,p=document)=>[...p.querySelectorAll(s)];
    let currentState = null;

    ws.onopen = ()=> console.log('WebSocket è¿æ¥å·²å»ºç«‹');
    ws.onclose = ()=> console.log('WebSocket è¿æ¥å·²å…³é—­');
    ws.onerror = (err)=> console.error('WebSocket é”™è¯¯:', err);

    ws.onmessage = (ev)=>{
      const msg = JSON.parse(ev.data);
      console.log('æ”¶åˆ°æ¶ˆæ¯:', msg);
      
      if(msg.type==='state'){ 
        currentState = msg.state; 
        renderAll(); 
        if(msg.new_game) console.log('âœ… æ–°æ¸¸æˆå¼€å§‹');
        if(msg.hand_complete) console.log('ğŸ ä¸€æ‰‹ç»“æŸï¼Œhand_complete =', msg.hand_complete);
        if(msg.hand_started) console.log('ğŸƒ æ–°ä¸€æ‰‹å¼€å§‹');
        if(msg.game_restarted) console.log('ğŸ”„ æ¸¸æˆå·²é‡å¯');
        if(msg.game_over) {
          console.log('ğŸ’€ æ¸¸æˆç»“æŸï¼Œgame_over =', msg.game_over);
        }
      }
      else if(msg.type==='ask_continue') {
        console.log('â“ æ”¶åˆ°è¯¢é—®æ˜¯å¦ç»§ç»­çš„æ¶ˆæ¯');
        showContinueDialog();
      }
      else if(msg.type==='ask_restart_or_exit') {
        console.log('â“ æ”¶åˆ°è¯¢é—®é‡æ–°å¼€å§‹æˆ–é€€å‡ºçš„æ¶ˆæ¯');
        showRestartOrExitDialog();
      }
      else if(msg.type==='game_exit') {
        alert('æ¸¸æˆå·²é€€å‡º');
        window.close();
      }
      else if(msg.type==='message') {
        console.log('Server:', msg.text);
      }
    };

    function renderAll(){
      renderPlayers(); renderCommunity(); renderSeats(); renderControls();
      $('#pot').textContent = 'å¥–æ± : '+(currentState?.pot_size||0);
      
      // æ›´æ–°è°ƒè¯•ä¿¡æ¯
      const phase = currentState?.game_phase || currentState?.phase || 'æœªçŸ¥';
      const currentPlayer = currentState?.current_player_index;
      const playerName = currentState?.players?.[currentPlayer]?.name || 'æ— ';
      $('#debug').textContent = `é˜¶æ®µ: ${phase} | å½“å‰: ${playerName}`;
    }

    function renderPlayers(){
      const root = $('#players');
      // ä¿ç•™ä¸Šæ–¹è®¾ç½®è¡¨å•
      const settings = root.children[0].cloneNode(true);
      root.innerHTML=''; root.appendChild(settings);
      
      // æ¸²æŸ“ç©å®¶åˆ—è¡¨
      const playersDiv = document.createElement('div');
      playersDiv.id = 'playersList';
      (currentState?.players||[]).forEach((p,i)=>{
        const div=document.createElement('div');
        div.className='player';
        
        // æ ¹æ®ç©å®¶çŠ¶æ€è®¾ç½®é¢œè‰²å’Œæ ·å¼
        const isCurrentPlayer = i === currentState?.current_player_index;
        const statusColor = p.status === 'active' ? '#22c55e' : 
                           p.status === 'folded' ? '#ef4444' : 
                           p.status === 'all_in' ? '#f59e0b' : '#6b7280';
        const statusText = p.status === 'active' ? 'æ´»è·ƒ' : 
                          p.status === 'folded' ? 'å¼ƒç‰Œ' : 
                          p.status === 'all_in' ? 'å…¨æŠ¼' : 'ç­‰å¾…';
        
        const dot = `<div style="width:10px;height:10px;border-radius:50%;background:${statusColor}" title="${statusText}"></div>`;
        
        // å¼ƒç‰Œç©å®¶çš„æ‰‹ç‰Œä¸æ˜¾ç¤º
        const hole = (p.hole_cards||[]).join(' ');
        let holeHtml = '';
        if (hole && p.status !== 'folded') {
          holeHtml = `<div style='font-size:12px;color:${isCurrentPlayer ? '#fbbf24' : '#93c5fd'}'>æ‰‹ç‰Œ: ${isCurrentPlayer ? hole : 'ğŸ‚  ğŸ‚ '}</div>`;
        } else if (p.status === 'folded') {
          holeHtml = `<div style='font-size:12px;color:#6b7280;text-decoration:line-through'>å·²å¼ƒç‰Œ</div>`;
        }
        
        // å¼ƒç‰Œç©å®¶æ•´ä½“æ ·å¼å˜æš—
        const playerStyle = p.status === 'folded' ? 'opacity:0.6;' : '';
        div.style.cssText = playerStyle;
        
        div.innerHTML=`<div class='avatar'>${p.name[0]}</div><div><div style='font-weight:800'>${p.name}</div><div style='color:#f2c94c;font-weight:900'>Â¥ ${p.chips}</div>${holeHtml}</div>${dot}`;
        playersDiv.appendChild(div);
      });
      root.appendChild(playersDiv);
      
      // é‡æ–°æŒ‚è½½è®¾ç½®åŒºåŸŸçš„äº‹ä»¶
      attachNewGameForm();
    }

    function renderCommunity(){
      const c = $('#community'); c.innerHTML='';
      (currentState?.community_cards||[]).forEach(txt=>{
        const red = /[â™¥â™¦]$/.test(txt);
        const card=document.createElement('div'); card.className='card'+(red?' red':''); card.textContent=txt; c.appendChild(card);
      });
    }

    function renderSeats(){
      const layer = $('#seats'); layer.innerHTML='';
      const tableRect = $('#table').getBoundingClientRect();
      const cx = tableRect.width/2, cy = tableRect.height/2; const rx = tableRect.width*0.36, ry = tableRect.height*0.33;
      const players=currentState?.players||[]; const n = Math.max(players.length,2);
      const angles=[...Array(n)].map((_,k)=>Math.PI*(0.5+2*k/n));
      players.forEach((p,i)=>{
        const a=angles[i]; const x=cx+rx*Math.cos(a); const y=cy+ry*Math.sin(a);
        const seat=document.createElement('div'); seat.className='seat';
        
        // å½“å‰ç©å®¶é«˜äº®ï¼Œå¼ƒç‰Œç©å®¶å˜æš—
        if(i===currentState?.current_player_index && p.status !== 'folded') {
          seat.classList.add('turn');
        }
        if(p.status === 'folded') {
          seat.style.opacity = '0.5';
          seat.style.filter = 'grayscale(50%)';
        }
        
        seat.style.left=x+'px'; seat.style.top=y+'px';
        const dealer = (i===currentState?.dealer_position)?'<div style="width:26px;height:26px;border-radius:50%;background:#fff;color:#111;display:grid;place-items:center;font-weight:900">D</div>':'';
        
        // æ ¹æ®ç©å®¶çŠ¶æ€æ˜¾ç¤ºæ‰‹ç‰Œ
        const hole = (p.hole_cards||[]).join(' ');
        let holeHtml = '';
        if (hole && p.status !== 'folded') {
          const isCurrentPlayer = i === currentState?.current_player_index;
          holeHtml = `<div style='margin-top:6px;color:${isCurrentPlayer?'#fbbf24':'#9ca3af'};font-weight:700'>${isCurrentPlayer ? hole : 'ğŸ‚  ğŸ‚ '}</div>`;
        } else if (p.status === 'folded') {
          holeHtml = `<div style='margin-top:6px;color:#6b7280;font-weight:700;text-decoration:line-through'>å¼ƒç‰Œ</div>`;
        }
        
        seat.innerHTML=`<div class='avatar'>${p.name[0]}</div><div><div style='font-weight:900;font-size:18px'>${p.name}</div><div style='color:#f2c94c;font-weight:900'>Â¥ ${p.chips}</div>${holeHtml}</div><div>${dealer}</div>`;
        layer.appendChild(seat);
      })
    }

    function renderControls(){
      const acts = new Set(currentState?.valid_actions||[]);
      
      // è°ƒè¯•ä¿¡æ¯
      console.log(`ğŸ® æ¸²æŸ“æ§åˆ¶é¢æ¿ï¼Œæœ‰æ•ˆåŠ¨ä½œ:`, Array.from(acts));
      
      // å¦‚æœæ²¡æœ‰æœ‰æ•ˆåŠ¨ä½œï¼Œè¯´æ˜å¯èƒ½å‡ºç°äº†é—®é¢˜
      if (acts.size === 0 && currentState?.players) {
        console.warn('âš ï¸  æ²¡æœ‰æœ‰æ•ˆåŠ¨ä½œï¼Œæ£€æŸ¥å½“å‰ç©å®¶çŠ¶æ€');
        const currentPlayer = currentState.players[currentState.current_player_index];
        if (currentPlayer) {
          console.log(`å½“å‰ç©å®¶: ${currentPlayer.name}, çŠ¶æ€: ${currentPlayer.status}`);
          if (currentPlayer.status === 'folded') {
            console.log('ğŸ”´ å½“å‰ç©å®¶å·²å¼ƒç‰Œï¼Œåº”è¯¥è‡ªåŠ¨è·³è¿‡');
            // å‘é€ä¸€ä¸ªæ£€æŸ¥è¯·æ±‚æ¥è§¦å‘æœåŠ¡å™¨ç«¯çš„ç©å®¶åˆ‡æ¢
            setTimeout(() => {
              ws.send(JSON.stringify({type: 'check_current_player'}));
            }, 100);
          }
        }
      }
      
      // æ£€æŸ¥å¼ƒç‰ŒæŒ‰é’®çŠ¶æ€
      const foldDisabled = !acts.has('fold');
      console.log(`ğŸ”´ å¼ƒç‰ŒæŒ‰é’®${foldDisabled ? 'ç¦ç”¨' : 'å¯ç”¨'}`);
      
      $('#fold').disabled = foldDisabled;
      $('#call').disabled = !(acts.has('call') || acts.has('check'));
      $('#raise').disabled = !acts.has('raise');
      $('#allin').disabled = !acts.has('all_in');

      if(acts.has('check')){
        $('#call').textContent = 'è¿‡ç‰Œ(C)';
        $('#call').title = 'æ— éœ€è·Ÿæ³¨';
      }else{
        $('#call').textContent = 'è·Ÿæ³¨(Space)';
        $('#call').title = 'éœ€è¦è·Ÿæ³¨: Â¥'+(currentState?.to_call||0);
      }

      // æ›´æ–°åŠ æ³¨æ»‘å—
      const currentBet = currentState?.current_bet || 0;
      const minRaise = currentState?.min_raise || currentState?.big_blind || 20;
      const minTotal = currentBet + minRaise;
      const maxTotal = Math.max(minTotal, (currentState?.pot_size||0)*2);
      
      const slider = $('#slider'); 
      slider.min = minTotal; 
      slider.max = maxTotal; 
      slider.step = Math.max(10, Math.ceil((maxTotal-minTotal)/50));
      
      if(Number(slider.value) < minTotal){ 
        slider.value = minTotal; 
        $('#val').textContent = 'Â¥ '+Number(slider.value).toLocaleString(); 
      }
    }

    // actions
    $('#slider').addEventListener('input', e=> $('#val').textContent='Â¥ '+Number(e.target.value).toLocaleString());
    $$('#fold,#call,#raise,#allin').forEach(btn=>btn.addEventListener('click',onAction));
    $$('[data-q]').forEach(b=>b.addEventListener('click',()=>quickBet(b.dataset.q)));

    function onAction(e){
      const id=e.target.id; let msg={type:'action'};
      
      console.log(`ğŸ¯ ç‚¹å‡»äº†æŒ‰é’®: ${id}`);
      console.log(`ğŸ“Š å½“å‰æœ‰æ•ˆåŠ¨ä½œ:`, currentState?.valid_actions);
      
      if(id==='fold') {
        msg.action='fold';
        console.log('ğŸ”´ å‘é€å¼ƒç‰ŒåŠ¨ä½œ');
      }
      if(id==='call'){
        const acts = new Set(currentState?.valid_actions||[]);
        msg.action = acts.has('check') ? 'check' : 'call';
        console.log(`ğŸ’° å‘é€ ${msg.action} åŠ¨ä½œ`);
      }
      if(id==='raise'){ 
        msg.action='raise'; 
        msg.amount=Number($('#slider').value)||0; 
        console.log(`ğŸ“ˆ å‘é€åŠ æ³¨åŠ¨ä½œï¼Œé‡‘é¢: ${msg.amount}`);
      }
      if(id==='allin') {
        msg.action='all_in';
        console.log('ğŸ”¥ å‘é€å…¨æŠ¼åŠ¨ä½œ');
      }
      
      console.log('ğŸ“¤ å‘é€æ¶ˆæ¯:', msg);
      ws.send(JSON.stringify(msg));
    }
    function quickBet(t){
      const pot = currentState?.pot_size||0; let v=0;
      if(t==='min') v = (currentState?.current_bet||0) + (currentState?.min_raise|| (currentState?.big_blind||20));
      if(t==='half') v = Math.round(pot/2);
      if(t==='pot') v = pot;
      if(t==='double') v = pot*2;
      $('#slider').value=v; $('#val').textContent='Â¥ '+v.toLocaleString();
    }

    // æ–°æ¸¸æˆé…ç½® UI
    function attachNewGameForm(){
      const wrap = $('#playersCfg'); 
      if(!wrap) return; // é˜²æ­¢é‡å¤è°ƒç”¨æ—¶ wrap ä¸å­˜åœ¨
      wrap.innerHTML='';
      
      const makeRow = (name, chips)=>{
        const row = document.createElement('div');
        row.style.display='flex'; row.style.gap='6px'; row.style.alignItems='center';
        row.innerHTML = `
          <input placeholder='ç©å®¶å' value='${name}' style="flex:1;background:#0f1419;color:#e5e7eb;border:1px solid #2a3745;border-radius:6px;padding:4px 6px"/>
          <input type='number' value='${chips}' min='100' step='50' style="width:90px;background:#0f1419;color:#e5e7eb;border:1px solid #2a3745;border-radius:6px;padding:4px 6px"/>
          <button class='btn' title='åˆ é™¤'>ï¼</button>
        `;
        row.querySelector('button').onclick = ()=> row.remove();
        wrap.appendChild(row);
      };
      // é»˜è®¤ä¸¤äºº
      makeRow('Alice', 1000); makeRow('Bob', 1000);
      
      // é‡æ–°ç»‘å®šæŒ‰é’®äº‹ä»¶
      const addBtn = $('#addP');
      const newGameBtn = $('#btnNewGame');
      
      if(addBtn) {
        addBtn.onclick = ()=>{
          const rows = $$('#playersCfg > div');
          if(rows.length>=9) return alert('æœ€å¤š9äºº');
          const idx = rows.length+1; const name = 'P'+idx;
          const row = document.createElement('div'); 
          row.style.display='flex'; row.style.gap='6px'; row.style.alignItems='center';
          row.innerHTML = `
            <input placeholder='ç©å®¶å' value='${name}' style="flex:1;background:#0f1419;color:#e5e7eb;border:1px solid #2a3745;border-radius:6px;padding:4px 6px"/>
            <input type='number' value='1000' min='100' step='50' style="width:90px;background:#0f1419;color:#e5e7eb;border:1px solid #2a3745;border-radius:6px;padding:4px 6px"/>
            <button class='btn' title='åˆ é™¤'>ï¼</button>`;
          row.querySelector('button').onclick = ()=> row.remove();
          $('#playersCfg').appendChild(row);
        };
      }
      
      if(newGameBtn) {
        newGameBtn.onclick = ()=>{
          console.log('æ–°æ¸¸æˆæŒ‰é’®è¢«ç‚¹å‡»');
          
          if(ws.readyState !== WebSocket.OPEN) {
            alert('WebSocket è¿æ¥æœªå»ºç«‹ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
            return;
          }
          
          const players = $$('#playersCfg > div').map(row=>{
            const [nameI, chipsI] = row.querySelectorAll('input');
            return {name:nameI.value.trim()||'P', chips:Number(chipsI.value)||1000};
          }).filter(p=>p.name && p.name !== 'P');
          
          console.log('è§£æåˆ°çš„ç©å®¶:', players);
          
          if(players.length < 2) {
            alert('è‡³å°‘éœ€è¦2åç©å®¶');
            return;
          }
          
          const cfg = { 
            small_blind:Number($('#sb').value)||10, 
            big_blind:Number($('#bb').value)||20, 
            players 
          };
          console.log('å‘é€æ–°æ¸¸æˆé…ç½®:', cfg);
          ws.send(JSON.stringify({type:'new_game', config: cfg}));
        };
      }
    }
    
    // å¯¹è¯æ¡†å‡½æ•°
    function showContinueDialog() {
      console.log('ğŸ”” showContinueDialog è¢«è°ƒç”¨');
      
      // æ˜¾ç¤ºå½“å‰ç­¹ç çŠ¶å†µ
      let chipsInfo = 'ğŸ‰ ä¸€è½®æ¸¸æˆç»“æŸï¼\n\nå½“å‰ç­¹ç çŠ¶å†µï¼š\n';
      if (currentState?.players) {
        currentState.players.forEach(p => {
          chipsInfo += `${p.name}: Â¥${p.chips.toLocaleString()}\n`;
        });
      }
      chipsInfo += '\næ˜¯å¦ç»§ç»­ä¸‹ä¸€è½®ï¼Ÿ';
      
      const result = confirm(chipsInfo + '\n\nç‚¹å‡»"ç¡®å®š"ç»§ç»­ä¸‹ä¸€è½®\nç‚¹å‡»"å–æ¶ˆ"é€‰æ‹©é‡æ–°å¼€å§‹æˆ–é€€å‡º');
      console.log('ğŸ‘¤ ç”¨æˆ·é€‰æ‹©ç»“æœ:', result ? 'ç»§ç»­' : 'åœæ­¢');
      
      if (result) {
        // ç»§ç»­ä¸‹ä¸€è½®
        ws.send(JSON.stringify({type: 'continue_game'}));
      } else {
        // è¯¢é—®é‡æ–°å¼€å§‹æˆ–é€€å‡º
        ws.send(JSON.stringify({type: 'ask_restart_or_exit'}));
      }
    }

    function showRestartOrExitDialog() {
      console.log('ğŸ”” showRestartOrExitDialog è¢«è°ƒç”¨');
      
      const result = confirm('ğŸ æ¸¸æˆç»“æŸï¼é€‰æ‹©ä¸‹ä¸€æ­¥æ“ä½œï¼š\n\nç‚¹å‡»"ç¡®å®š"é‡æ–°å¼€å§‹ï¼ˆé‡ç½®ç­¹ç ï¼‰\nç‚¹å‡»"å–æ¶ˆ"é€€å‡ºæ¸¸æˆ');
      console.log('ğŸ‘¤ ç”¨æˆ·é€‰æ‹©ç»“æœ:', result ? 'é‡æ–°å¼€å§‹' : 'é€€å‡º');
      
      if (result) {
        // é‡æ–°å¼€å§‹æ¸¸æˆ
        ws.send(JSON.stringify({type: 'restart_game'}));
      } else {
        // é€€å‡ºæ¸¸æˆ
        if (confirm('ç¡®å®šè¦é€€å‡ºæ¸¸æˆå—ï¼Ÿ')) {
          ws.send(JSON.stringify({type: 'exit_game'}));
        } else {
          // ç”¨æˆ·å–æ¶ˆé€€å‡ºï¼Œé‡æ–°æ˜¾ç¤ºé€‰æ‹©å¯¹è¯æ¡†
          showRestartOrExitDialog();
        }
      }
    }

    // åˆ›å»ºæ›´ç¾è§‚çš„è‡ªå®šä¹‰å¯¹è¯æ¡†ï¼ˆå¯é€‰ï¼‰
    function createCustomDialog(title, message, buttons) {
      // åˆ›å»ºé®ç½©å±‚
      const overlay = document.createElement('div');
      overlay.style.cssText = `
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.7); z-index: 1000; display: flex;
        align-items: center; justify-content: center;
      `;
      
      // åˆ›å»ºå¯¹è¯æ¡†
      const dialog = document.createElement('div');
      dialog.style.cssText = `
        background: #1f2937; border-radius: 12px; padding: 24px;
        min-width: 320px; max-width: 500px; color: #e5e7eb;
        box-shadow: 0 20px 25px -5px rgba(0,0,0,0.5);
      `;
      
      dialog.innerHTML = `
        <h3 style="margin: 0 0 16px 0; color: #fbbf24; font-size: 18px;">${title}</h3>
        <p style="margin: 0 0 20px 0; line-height: 1.5; color: #d1d5db;">${message}</p>
        <div style="display: flex; gap: 12px; justify-content: flex-end;">
          ${buttons.map((btn, i) => `
            <button onclick="handleDialogClick(${i})" style="
              padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer;
              background: ${btn.primary ? '#2563eb' : '#6b7280'}; color: white;
              font-weight: 500; transition: all 0.2s;
            " onmouseover="this.style.opacity='0.8'" onmouseout="this.style.opacity='1'">
              ${btn.text}
            </button>
          `).join('')}
        </div>
      `;
      
      overlay.appendChild(dialog);
      document.body.appendChild(overlay);
      
      return new Promise(resolve => {
        window.handleDialogClick = (index) => {
          document.body.removeChild(overlay);
          delete window.handleDialogClick;
          resolve(index);
        };
      });
    }

    // åˆå§‹åŒ–é…ç½®è¡¨å•
    attachNewGameForm();
  </script>
</body>
</html>


